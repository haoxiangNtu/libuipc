
// > Squared Version
// > D := d*d

// 示例：计算顶点x_a与面接触点x_b的穿透深度d
template <typename T>
__host__ __device__ T ComputePenetrationDepth(const T x_a[3], const T x_b[3], const T n_hat[3])
{
    // 计算(x_b - x_a) · n̂
    T dot = (x_b[0] - x_a[0]) * n_hat[0] + (x_b[1] - x_a[1]) * n_hat[1]
            + (x_b[2] - x_a[2]) * n_hat[2];
    // 穿透深度d = max(0, dot)（仅保留非负穿透）
    return dot > 1e-12 ? dot : static_cast<T>(0.0);
}

/*****************************************************************************************************************************
函数功能：计算碰撞能量（文章定义的二次碰撞能量 E_c = 0.5 * k_c * d²）
函数名：KappaQuadratic（替换原KappaBarrier）
参数说明：
- R: 输出参数，存储计算得到的碰撞能量
- k_c: 碰撞刚度（文章中记为k_c，参考实验参数设置为1e6~1e7）
- d: 穿透深度（需提前计算：d = max(0, (x_b - x_a) · ň)，仅非负值有效）
模板特性：支持任意浮点类型（float/double），兼容CPU/GPU双端调用
*****************************************************************************************************************************/
template <typename T>
__host__ __device__ void KappaQuadratic(T& R, const T& k_c, const T& d, const T& dHat, const T& xi)
{
    // 数值稳定性：忽略极小穿透（避免浮点误差导致的无效计算）
    if(d > 1e-12)
    {
        R = 0.5 * k_c * d * d;  // 核心公式：二次碰撞能量 E_c = 1/2 * k_c * d²
    }
    else
    {
        R = static_cast<T>(0.0);  // 无穿透时（d≤0），碰撞能量为0
    }
}

/*****************************************************************************************************************************
函数功能：碰撞能量对穿透深度d的一阶导数（用于计算碰撞力 f_c = -dE_c/dd）
函数名：dKappaQuadraticdD（替换原dKappaBarrierdD）
参数说明：
- R: 输出参数，存储计算得到的一阶导数
- k_c: 碰撞刚度（与能量计算中的k_c一致）
- d: 穿透深度（同前，仅非负值有效）
物理意义：导数结果为 k_c*d，负号需在外部计算碰撞力时添加（f_c = -R）
*****************************************************************************************************************************/
template <typename T>
__host__ __device__ void dKappaQuadraticdD(T& R, const T& k_c, const T& d, const T& dHat, const T& xi)
{
    if(d > 1e-12)
    {
        R = k_c * d;  // 一阶导数：dE_c/dd = k_c * d
    }
    else
    {
        R = static_cast<T>(0.0);  // 无穿透时，导数为0（无碰撞力）
    }
}

/*****************************************************************************************************************************
函数功能：碰撞能量对穿透深度d的二阶导数（用于计算碰撞项的Hessian矩阵）
函数名：ddKappaQuadraticddD（替换原ddKappaBarrierddD）
参数说明：
- R: 输出参数，存储计算得到的二阶导数
- k_c: 碰撞刚度（与能量计算中的k_c一致）
- d: 穿透深度（同前，仅非负值有效）
物理意义：二阶导数为常数k_c，用于构建VBD局部迭代的3×3 Hessian矩阵
*****************************************************************************************************************************/
template <typename T>
__host__ __device__ void ddKappaQuadraticddD(T& R, const T& k_c, const T& d, const T& dHat, const T& xi)
{
    if(d > 1e-12)
    {
        R = k_c;  // 二阶导数：d²E_c/dd² = k_c（二次函数的二阶导数为常数）
    }
    else
    {
        R = static_cast<T>(0.0);  // 无穿透时，二阶导数为0（碰撞项不影响Hessian）
    }
}